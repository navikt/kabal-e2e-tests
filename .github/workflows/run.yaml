name: Manual E2E

on:
  workflow_dispatch:
    inputs:
      e2e_tag:
        description: "Deleted branch tag of E2E image to run"
        required: false
        type: string
  workflow_call:
    inputs:
      e2e_tag:
        description: "Tag of E2E image to run"
        required: false
        default: latest
        type: string
    secrets:
      NAIS_DEPLOY_APIKEY:
        description: "API key for nais/deploy"
        required: true
      NAIS_WORKLOAD_IDENTITY_PROVIDER:
        description: "Identity provider for nais/login"
        required: true

run-name: E2E (${{ (inputs.e2e_tag != '' && inputs.e2e_tag) || (github.ref == 'refs/heads/main' && 'latest' || github.ref_name) }})

jobs:
  e2e_tests:
    name: E2E
    runs-on: ubuntu-latest
    steps:
      - name: Get image registry
        id: image-registry
        uses: nais/login@v0
        with:
          project_id: ${{ vars.NAIS_MANAGEMENT_PROJECT_ID }}
          identity_provider: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}
          team: klage
      
      - name: Generate UUID
        id: uuid
        shell: bash
        run: echo "uuid=$(uuidgen)" >> $GITHUB_OUTPUT

      - name: Get image tag
        id: image-tag
        shell: bash
        run: |
          if [[ -n "${{ inputs.e2e_tag }}" ]]; then
            echo "tag=${{ inputs.e2e_tag }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Generate image name
        id: image
        shell: bash
        run: echo "image=${{ steps.image-registry.outputs.registry }}/klage/kabal-e2e-tests:${{ steps.image-tag.outputs.tag }}" >> $GITHUB_OUTPUT

      - name: Run E2E tests
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: dev-gcp
          VAR: jobid=${{ steps.uuid.outputs.uuid }},image=${{ steps.image.outputs.image }}
          TEAM: klage
          RESOURCE: nais/e2ejob.yaml
          IMAGE: ${{ steps.image.outputs.image }}
